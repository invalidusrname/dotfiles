# add key to remote server

function authme {
  ssh $1 'cat >>.ssh/authorized_keys' <~/.ssh/id_rsa.pub
}

if [ -r $HOME/.git-completion.sh ];
then
  source $HOME/.git-completion.sh
fi

if [ -r $HOME/.git-prompt.sh ];
then
  source $HOME/.git-prompt.sh
fi

function parse_git_branch {
  branch_prompt=$(__git_ps1)
  if [ -n "$branch_prompt" ]; then
    status_icon=$(git_status)
    echo "$branch_prompt$status_icon "
  fi
}

# Show character if changes are pending
function git_status() {
  if current_git_status=$(git status | grep 'added to commit' 2> /dev/null); then
    echo ' +'
  fi
}

# For running specific features.
function rff {
 rake features FEATURE=features/"$1".feature
}

# For running specific line numbers
function rffl {
 cucumber features/"$1".feature:"$2"
}

# run puppet in development mode
function rp {
  sudo puppet apply --environment development --debug --confdir /var/puppet /var/puppet/environments/development/manifests
}

function git_report {
  x=`pwd`
  if [ -d $1/.git ]; then
    cd $1
    OUT=$(git $2)
    if [ ! -z "$OUT" ]; then
      basename `pwd`
      echo "$OUT"
    fi
    OUT=''
  else
    for d in $1/*; do
      cd $d
      OUT=$(git $2)
      if [ ! -z "$OUT" ]; then
        basename `pwd`
        echo "$OUT"
      fi
      OUT=''
    done
  fi

  cd $x
}

function lw {
  git_report /var/apps lw
  git_report /var/gems lw
  git_report /var/gems lw
}

function cw {
  git_report /var/apps cw
  git_report /var/gems cw
}

function td {
  git_report /var/apps td
  git_report /var/gems td
  git_report /var/puppet td
}


man() {
  env \
    LESS_TERMCAP_mb=$(printf "\e[1;31m") \
    LESS_TERMCAP_md=$(printf "\e[1;31m") \
    LESS_TERMCAP_me=$(printf "\e[0m") \
    LESS_TERMCAP_se=$(printf "\e[0m") \
    LESS_TERMCAP_so=$(printf "\e[1;44;33m") \
    LESS_TERMCAP_ue=$(printf "\e[0m") \
    LESS_TERMCAP_us=$(printf "\e[1;32m") \
      man "$@"
}

function pv() {
  local d="${1:-$HOME/Downloads/torrents/complete}"
  local extension="${2:-mp4}"

  for F in $(find "$d" | grep "$extension"); do
    if [ -f "$F" ]; then
      NAME=$(basename $F)
      DESTINATION="$d/$NAME"
      if [[ "$F" != "$DESTINATION" ]]; then
        echo "Moving $F to $DESTINATION"
        mv "$F" $DESTINATION;
      fi
    fi
  done
}

function local_env() {
    LOCAL_FILE=$1
    DEFAULT_LOCAL_FILE=".env.local"

    if [ -z "$LOCAL_FILE" ]; then
      LOCAL_FILE=$DEFAULT_LOCAL_FILE
    fi

    if [ -f "$LOCAL_FILE" ]; then
      set -a;
      source $LOCAL_FILE;
      set +a;
      echo "loaded $LOCAL_FILE"
    else
      echo "unable to load $LOCAL_FILE"
    fi

}

function update_ruby_versions() {
  mise cache clean
  mise ls-remote ruby
}

clean_branches() {
  git remote prune origin
  git branch -vv | grep "origin/.*: gone]" | awk '{print $1}' | xargs git branch -D
}

function dce() {
  if [[ $1 != "" ]]; then
    SERVICE="$1"
  else
    SERVICE="app"
  fi

  if [[ $2 != "" ]]; then
    CMD="$2"
  else
    CMD="/bin/bash"
  fi

  COMPOSE_FILE="docker-compose.yml"
  OVERRIDE_FILE="docker-compose.overrides.yml"

  if [ -f "docker-compose.yaml" ]; then
    COMPOSE_FILE="docker-compose.yaml"
    OVERRIDE_FILE="docker-compose.overrides.yaml"
  elif [ -f "compose.yaml" ]; then
    COMPOSE_FILE="compose.yaml"
    OVERRIDE_FILE="compose.overrides.yaml"
  fi

  if [ -f ${OVERRIDE_FILE} ]; then
    FULL_CMD="docker compose -f ${COMPOSE_FILE} -f ${OVERRIDE_FILE} exec $SERVICE $CMD"
    echo $FULL_CMD
    docker compose -f ${COMPOSE_FILE} -f ${OVERRIDE_FILE} exec $SERVICE $CMD
  elif [ -f $COMPOSE_FILE ]; then
    FULL_CMD="docker compose -f ${COMPOSE_FILE} exec $SERVICE $CMD"
    echo $FULL_CMD
    docker compose -f ${COMPOSE_FILE} exec $SERVICE $CMD
  else
    echo "no ${COMPOSE_FILE} file found"
  fi
}

function dcor() {
  if [[ $1 != "" ]]; then
    SERVICE="$1"
  else
    SERVICE="app"
  fi

  if [[ $2 != "" ]]; then
    CMD="$2"
  else
    CMD="/bin/bash"
  fi

  COMPOSE_FILE="docker-compose.yml"
  OVERRIDE_FILE="docker-compose.override.yml"

  if [ -f "docker-compose.yaml" ]; then
    COMPOSE_FILE="docker-compose.yaml"
    OVERRIDE_FILE="docker-compose.override.yaml"
  elif [ -f "compose.yaml" ]; then
    COMPOSE_FILE="compose.yaml"
    OVERRIDE_FILE="compose.override.yaml"
  fi

  if [ -f ${OVERRIDE_FILE} ]; then
    DEBUGGING="docker compose -f ${COMPOSE_FILE} -f ${OVERRIDE_FILE} run --rm $SERVICE $CMD"
    echo $DEBUGGING
    docker compose -f ${COMPOSE_FILE} -f ${OVERRIDE_FILE} run --rm $SERVICE $CMD
  elif [ -f $COMPOSE_FILE ]; then
    DEBUGGING="docker compose -f ${COMPOSE_FILE} run --rm $SERVICE $CMD"
    echo $DEBUGGING
    docker compose -f ${COMPOSE_FILE} run --rm $SERVICE $CMD
  else
    echo "no ${COMPOSE_FILE} file found"
  fi
}


function microk8s_token() {
  K8S_HOST=um580
  ssh $K8S_HOST 'microk8s kubectl create token default'
}

function mdls_it() {
  if [[ $1 != "" ]]; then
    P="$1"
  else
    P="."
  fi

  for F in $(find $P -type f -not -name "*.txt" -not -name ".DS_Store" -not -name ".part"); do
    TXT=$F.txt;
    if [[ ! -f "$TXT" ]]; then
      echo "[ADD] $TXT";
      mdls $F > $F.txt
    else
      echo "[SKIP] $TXT";
    fi
  done
}

function pyclean () {
  find . -type f -name "*.py[co]" -delete
  find . -type d -name "__pycache__" -exec rm -rf {} +
}


function gitsearch() {
    git grep "$1" $(git branch -a --format='%(refname:short)')
}

function glab-issue-feature() {
  local BRANCH_LIMIT=120
  local issue_num=$1

  if [ -z "$issue_num" ]; then
    echo "Usage: glab-issue-feature <issue_num>"
    return 1
  fi

  local issue_title=$(glab issue view "$issue_num" --output json | jq -r .title | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')

  if [ -z "$issue_title" ]; then
    echo "Error: Could not fetch issue title."
    return 1
  fi

  local branch_prefix="feature/${issue_num}-"
  local full_branch="${branch_prefix}${issue_title}"

  if [ ${#full_branch} -ge $BRANCH_LIMIT ]; then
    local max_title_len=$((BRANCH_LIMIT - 1 - ${#branch_prefix}))
    issue_title="${issue_title:0:${max_title_len}}"
    issue_title=$(echo "$issue_title" | sed 's/-*$//')  # Remove trailing hyphens after truncate
    full_branch="${branch_prefix}${issue_title}"
  fi

  git checkout -b "$full_branch"
}


function dmigrate() {
  local service="${1:-api}"
  docker compose run --rm "$service" sh -c "bundle install && bundle exec rails db:migrate"
}

function drun() {
  local service="${1:-app}"
  local cmd="${2:-/bin/bash}"
  docker compose run --rm "$service" "$cmd"
}

function gitea_add_remote() {
  REPO=$(basename $PWD)
  git remote add gitea https://git.invalid8.com/invalidusrname/${REPO}.git
  git push -u gitea master
}

